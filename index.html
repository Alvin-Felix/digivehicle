<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>DigiLoan Field Tool</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"DigiLoan Field","short_name":"DigiLoan","start_url":".","display":"standalone","background_color":"#f8fafc","theme_color":"#2563eb","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/744/744465.png","sizes":"192x192","type":"image/png"}]}'>

    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --warning: #f59e0b;
            --danger: #dc2626;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            background: var(--primary);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .brand-block { display: flex; align-items: center; }
        .brand-icon { font-size: 1.5rem; margin-right: 10px; }
        
        .lang-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.5);
            color: white;
            padding: 6px 14px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
        }

        /* --- Main Content --- */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 100px; 
        }

        /* --- Cards & Inputs --- */
        .step-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            animation: slideIn 0.3s ease-out;
            border: 1px solid #e2e8f0;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .section-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 15px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .input-group { margin-bottom: 20px; }

        label {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #475569;
        }

        /* --- Voice UI --- */
        .voice-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .voice-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-speak { background: #eff6ff; color: var(--primary); }
        .btn-listen { background: #fef2f2; color: var(--danger); }
        
        .speaking { background: var(--primary) !important; color: white !important; animation: pulseBlue 1.2s infinite; }
        .listening { background: var(--danger) !important; color: white !important; animation: pulseRed 1.2s infinite; }

        @keyframes pulseBlue { 0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.6); } 70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.6); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }

        /* --- Form Fields --- */
        input, select {
            width: 100%;
            padding: 14px;
            font-size: 1.1rem;
            border: 2px solid #cbd5e1;
            border-radius: 10px;
            background: #f8fafc;
            transition: border-color 0.2s;
        }
        input:focus, select:focus { border-color: var(--primary); outline: none; background: white; }

        /* --- Footer Nav --- */
        .nav-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .nav-btn {
            border: none;
            border-radius: 12px;
            padding: 16px 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-prev { background: #f1f5f9; color: #64748b; }
        .btn-next { background: var(--success); color: white; flex-grow: 1; margin-left: 15px; }
        .btn-save { background: var(--primary); color: white; flex-grow: 1; margin-left: 15px; }
        .nav-btn svg { width: 28px; height: 28px; fill: currentColor; }

        /* --- Dashboard --- */
        .dash-container { text-align: center; padding-top: 30px; }
        
        .big-start-btn {
            background: linear-gradient(135deg, var(--primary), #1d4ed8);
            color: white;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 8px solid #dbeafe;
            font-size: 1.5rem;
            font-weight: 700;
            cursor: pointer;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
            transition: transform 0.1s;
        }
        .big-start-btn:active { transform: scale(0.96); }

        .export-btn {
            background: var(--success);
            color: white;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            width: 100%;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 600;
        }

    </style>
</head>
<body>

<header>
    <div class="brand-block">
        <span class="brand-icon">üõ°Ô∏è</span>
        <div style="line-height:1.2">
            <div style="font-weight:bold">DigiLoan</div>
            <div style="font-size:0.8rem; opacity:0.9">Secure Field Tool</div>
        </div>
    </div>
    <button class="lang-btn" onclick="app.toggleLang()" id="langBtn">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
</header>

<main id="app-root">
    <!-- Dynamic Content -->
</main>

<div class="nav-footer" id="navFooter" style="display:none;">
    <button class="nav-btn btn-prev" onclick="app.prev()">
        <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </button>
    <button class="nav-btn btn-next" id="nextBtn" onclick="app.next()">
        <svg viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>
    </button>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const schema = [
        {
            id: 'identity',
            title_en: "Identity",
            title_ta: "‡ÆÖ‡Æü‡Øà‡ÆØ‡Ææ‡Æ≥‡ÆÆ‡Øç",
            fields: [
                { id: 'cust_type', type: 'select', label_en: 'Customer Type', label_ta: '‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç ‡Æµ‡Æï‡Øà', opts: ['New', 'Existing'] },
                { id: 'mobile', type: 'text', inputmode: 'numeric', maxlength: 10, label_en: 'Mobile Number', label_ta: '‡ÆÆ‡Øä‡Æ™‡Øà‡Æ≤‡Øç ‡Æé‡Æ£‡Øç' },
                { id: 'cif', type: 'text', inputmode: 'numeric', maxlength: 20, label_en: 'CIF Number', label_ta: '‡Æö‡Æø‡Æê‡Æé‡ÆÉ‡Æ™‡Øç (CIF) ‡Æé‡Æ£‡Øç' }
            ]
        },
        {
            id: 'personal',
            title_en: "Personal Details",
            title_ta: "‡Æ§‡Æ©‡Æø‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç",
            fields: [
                { id: 'fullname', type: 'text', label_en: 'Full Name', label_ta: '‡ÆÆ‡ØÅ‡Æ¥‡ØÅ ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç' },
                { id: 'father', type: 'text', label_en: "Father's Name", label_ta: '‡Æ§‡Æ®‡Øç‡Æ§‡Øà‡ÆØ‡Æø‡Æ©‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç' },
                { id: 'dob', type: 'date', label_en: 'Date of Birth', label_ta: '‡Æ™‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡Æ§‡Øá‡Æ§‡Æø' },
                { id: 'aadhaar', type: 'text', inputmode: 'numeric', maxlength: 12, label_en: 'Aadhaar Number', label_ta: '‡ÆÜ‡Æ§‡Ææ‡Æ∞‡Øç ‡Æé‡Æ£‡Øç' }
            ]
        },
        {
            id: 'address',
            title_en: "Address",
            title_ta: "‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Æø",
            fields: [
                { id: 'addr_l1', type: 'text', label_en: 'Door No / Street', label_ta: '‡Æï‡Æ§‡Æµ‡ØÅ ‡Æé‡Æ£‡Øç / ‡Æ§‡ØÜ‡Æ∞‡ØÅ' },
                { id: 'addr_city', type: 'text', label_en: 'Village / City', label_ta: '‡Æï‡Æø‡Æ∞‡Ææ‡ÆÆ‡ÆÆ‡Øç / ‡Æ®‡Æï‡Æ∞‡ÆÆ‡Øç' },
                { id: 'addr_pin', type: 'text', inputmode: 'numeric', maxlength: 6, label_en: 'Pincode', label_ta: '‡ÆÖ‡Æû‡Øç‡Æö‡Æ≤‡Øç ‡Æï‡ØÅ‡Æ±‡Æø‡ÆØ‡ØÄ‡Æü‡ØÅ' }
            ]
        },
        {
            id: 'income',
            title_en: "Income Details",
            title_ta: "‡Æµ‡Æ∞‡ØÅ‡ÆÆ‡Ææ‡Æ© ‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç",
            fields: [
                { id: 'emp_type', type: 'select', label_en: 'Job Type', label_ta: '‡Æµ‡Øá‡Æ≤‡Øà ‡Æµ‡Æï‡Øà', opts: ['Salaried', 'Self-Employed'] },
                { id: 'income', type: 'text', inputmode: 'numeric', label_en: 'Monthly Income', label_ta: '‡ÆÆ‡Ææ‡Æ§ ‡Æµ‡Æ∞‡ØÅ‡ÆÆ‡Ææ‡Æ©‡ÆÆ‡Øç' },
                { id: 'loan_amt', type: 'text', inputmode: 'numeric', label_en: 'Loan Needed', label_ta: '‡Æ§‡Øá‡Æµ‡Øà‡ÆØ‡Ææ‡Æ© ‡Æï‡Æü‡Æ©‡Øç ‡Æ§‡Øä‡Æï‡Øà' }
            ]
        },
        {
            id: 'field_check',
            title_en: "Verification",
            title_ta: "‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡ØÅ",
            fields: [
                { id: 'fi_person', type: 'text', label_en: 'Person Met', label_ta: '‡Æö‡Æ®‡Øç‡Æ§‡Æø‡Æ§‡Øç‡Æ§ ‡Æ®‡Æ™‡Æ∞‡Øç' },
                { id: 'fi_rec', type: 'select', label_en: 'Recommendation', label_ta: '‡Æ™‡Æ∞‡Æø‡Æ®‡Øç‡Æ§‡ØÅ‡Æ∞‡Øà', opts: ['Approve', 'Reject'] }
            ]
        }
    ];

    const app = {
        lang: 'ta',
        step: -1,
        data: {},
        records: [],
        voices: [],

        // --- INIT ---
        init: function() {
            // Load Records
            const saved = localStorage.getItem('DigiLoan_Records');
            if (saved) app.records = JSON.parse(saved);

            // Voice Setup
            if ('speechSynthesis' in window) {
                app.voices = window.speechSynthesis.getVoices();
                window.speechSynthesis.onvoiceschanged = () => {
                    app.voices = window.speechSynthesis.getVoices();
                };
            }
            app.renderDashboard();
        },

        // --- RENDERERS ---
        toggleLang: function() {
            app.lang = app.lang === 'ta' ? 'en' : 'ta';
            document.getElementById('langBtn').innerText = app.lang === 'ta' ? '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç' : 'English';
            if(app.step > -1) app.renderStep();
            else app.renderDashboard();
        },

        renderDashboard: function() {
            const t = app.lang === 'ta' 
                ? { start: "‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡ØÅ", saved: "‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç", export: "CSV ‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Æ§‡Æø" }
                : { start: "START", saved: "Records", export: "Export CSV" };

            document.getElementById('navFooter').style.display = 'none';
            document.getElementById('app-root').innerHTML = `
                <div class="dash-container">
                    <button class="big-start-btn" onclick="app.startSurvey()">
                        <div style="font-size:3rem">‚ñ∂</div>
                        <div>${t.start}</div>
                    </button>
                    
                    <div style="margin-top:40px; color:#64748b">
                        <div style="font-size:2rem; font-weight:bold; color:var(--text)">${app.records.length}</div>
                        <div>${t.saved}</div>
                    </div>

                    ${app.records.length > 0 ? `
                    <button class="export-btn" onclick="app.exportCSV()">
                        <span>üîí</span> ${t.export}
                    </button>` : ''}
                </div>
            `;
        },

        renderStep: function() {
            const stepData = schema[app.step];
            const title = app.lang === 'ta' ? stepData.title_ta : stepData.title_en;
            
            document.getElementById('navFooter').style.display = 'flex';
            const nextBtn = document.getElementById('nextBtn');
            
            if (app.step === schema.length - 1) {
                nextBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>`;
                nextBtn.className = 'nav-btn btn-save';
            } else {
                nextBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>`;
                nextBtn.className = 'nav-btn btn-next';
            }

            const fieldsHtml = stepData.fields.map(f => {
                const label = app.lang === 'ta' ? f.label_ta : f.label_en;
                const val = app.data[f.id] || '';
                
                let inputHtml = '';
                if (f.type === 'select') {
                    inputHtml = `<select id="${f.id}" onchange="app.save('${f.id}', this.value)">
                        <option value="">...</option>
                        ${f.opts.map(o => `<option value="${o}" ${val===o?'selected':''}>${o}</option>`).join('')}
                    </select>`;
                } else {
                    inputHtml = `<input type="${f.type}" 
                                        id="${f.id}" 
                                        value="${val}" 
                                        ${f.inputmode ? `inputmode="${f.inputmode}"` : ''} 
                                        ${f.maxlength ? `maxlength="${f.maxlength}"` : ''} 
                                        oninput="app.save('${f.id}', this.value)">`;
                }

                return `
                    <div class="step-card">
                        <label>${label}</label>
                        <div class="voice-bar">
                            <button class="voice-btn btn-speak" onclick="app.speak('${label}', this)">üîä</button>
                            ${f.type !== 'select' ? `<button class="voice-btn btn-listen" id="mic-${f.id}" onclick="app.listen('${f.id}')">üé§</button>` : ''}
                        </div>
                        <div class="input-group">${inputHtml}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('app-root').innerHTML = `
                <div class="section-title">
                    ${title}
                    <button class="voice-btn btn-speak" style="width:32px;height:32px;font-size:1rem" onclick="app.speak('${title}', this)">üîä</button>
                </div>
                ${fieldsHtml}
                <div style="height:30px"></div>
            `;
            setTimeout(() => app.speak(title), 500);
        },

        // --- CORE ACTIONS ---
        startSurvey: function() {
            app.speak(" "); // Audio unlock
            app.step = 0;
            app.data = { 
                record_id: Date.now(), 
                timestamp: new Date().toISOString()
            };
            app.renderStep();
        },

        next: function() {
            if (app.step < schema.length - 1) {
                app.step++;
                app.renderStep();
            } else {
                app.finish();
            }
        },

        prev: function() {
            if (app.step > 0) {
                app.step--;
                app.renderStep();
            } else {
                app.step = -1;
                app.renderDashboard();
            }
        },

        save: function(key, val) {
            app.data[key] = val;
        },

        // --- CRYPTOGRAPHY & SAVING ---
        finish: async function() {
            // Generate Tamper-Proof Hash
            const dataString = JSON.stringify(app.data);
            const hash = await app.sha256(dataString);
            app.data.hash = hash.substring(0, 16); // Store first 16 chars for integrity check

            app.records.push(app.data);
            localStorage.setItem('DigiLoan_Records', JSON.stringify(app.records));
            
            const msg = app.lang === 'ta' ? "‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ" : "Saved Securely";
            app.speak(msg);
            alert(msg);
            app.step = -1;
            app.renderDashboard();
        },

        sha256: async function(message) {
            // Browser native crypto API (Secure Context or Localhost/File required)
            if (!crypto || !crypto.subtle) return "NO_CRYPTO_" + Date.now();
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        },

        // --- VOICE ENGINE ---
        speak: function(text, btn) {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            app.voices = window.speechSynthesis.getVoices();
            
            // Priority: Tamil -> Indian English -> Any English
            let v = app.lang === 'ta' ? app.voices.find(v => v.lang.includes('ta')) : null;
            if (!v) v = app.voices.find(v => v.lang.includes('en-IN'));
            if (!v) v = app.voices.find(v => v.lang.startsWith('en'));
            if (v) utterance.voice = v;

            if (btn) {
                btn.classList.add('speaking');
                utterance.onend = () => btn.classList.remove('speaking');
                utterance.onerror = () => btn.classList.remove('speaking');
            }
            window.speechSynthesis.speak(utterance);
        },

        listen: function(fieldId) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("Use Chrome/Edge for Mic");
                return;
            }
            const btn = document.getElementById(`mic-${fieldId}`);
            const input = document.getElementById(fieldId);
            const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new Rec();

            recognition.lang = app.lang === 'ta' ? 'ta-IN' : 'en-IN';
            recognition.interimResults = false;
            
            btn.classList.add('listening');
            recognition.onresult = (e) => {
                const txt = e.results[0][0].transcript;
                input.value = txt;
                app.save(fieldId, txt);
                btn.classList.remove('listening');
            };
            recognition.onerror = () => btn.classList.remove('listening');
            recognition.onend = () => btn.classList.remove('listening');
            recognition.start();
        },

        // --- EXPORT ---
        exportCSV: function() {
            if (app.records.length === 0) return;
            // Build Headers
            let headers = ['RecordID', 'Timestamp', 'IntegrityHash'];
            schema.forEach(s => s.fields.forEach(f => headers.push(f.id)));
            
            const rows = [headers.join(',')];
            app.records.forEach(rec => {
                const row = headers.map(h => {
                    let val = rec[h] || '';
                    if(h === 'RecordID') val = rec['record_id'];
                    if(h === 'IntegrityHash') val = rec['hash'];
                    
                    val = String(val).replace(/"/g, '""');
                    if (val.search(/("|,|\n)/g) >= 0) val = `"${val}"`;
                    return val;
                });
                rows.push(row.join(','));
            });

            const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DigiLoan_Secure_${Date.now()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    };

    window.onload = app.init;
</script>
</body>
</html>
